
@page "/lista-usuarios"
@using BlazorRegistroUsuarios.Data.Models
@using BlazorRegistroUsuarios.Services
@using BlazorRegistroUsuarios.Shared.Components
@attribute [Authorize(Roles = "Administrador")]
@inject IUsuarioService UsuarioService
@inject PdfGenerator PdfGenerator
@inject IJSRuntime JSRuntime
@inject PdfGenerator PdfGenerator

<h3>Listado de Usuarios Registradores</h3>

<div class="mb-4">
    <div class="row">
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Buscar por nombre o documento..."
                       @bind="filtroBusqueda" @bind:event="oninput" />
                <button class="btn btn-outline-secondary" type="button" @onclick="LimpiarFiltro">
                    Limpiar
                </button>
            </div>
        </div>
        <div class="col-md-6 text-end">
            <a href="/registro-usuario" class="btn btn-success me-2">
                <i class="bi bi-person-plus"></i> Nuevo Usuario
            </a>
            <button class="btn btn-primary" @onclick="GenerarPDF" disabled="@isGenerandoPDF">
                @if (isGenerandoPDF)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                }
                <i class="bi bi-file-pdf"></i> Descargar PDF
            </button>
        </div>
    </div>
</div>

@if (usuarios == null)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Documento</th>
                    <th>Nombre Completo</th>
                    <th>Correo</th>
                    <th>Trabaja</th>
                    <th>Activo</th>
                    <th>Permiso</th>
                    <th>Fecha Registro</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var usuario in usuariosFiltrados)
                {
                    <tr>
                        <td>@usuario.NumeroDocumento</td>
                        <td>@usuario.NombreCompleto</td>
                        <td>@usuario.Correo</td>
                        <td>
                            <span class="badge @(usuario.Trabaja ? "bg-success" : "bg-secondary")">
                                @(usuario.Trabaja ? "Sí" : "No")
                            </span>
                        </td>
                        <td>
                            <span class="badge @(usuario.Activo ? "bg-success" : "bg-danger")">
                                @(usuario.Activo ? "Sí" : "No")
                            </span>
                        </td>
                        <td>
                            <span class="badge @(usuario.Permiso == "Administrador" ? "bg-warning" : "bg-info")">
                                @usuario.Permiso
                            </span>
                        </td>
                        <td>@usuario.FechaRegistro.ToString("dd/MM/yyyy HH:mm")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="text-muted">
        Mostrando @usuariosFiltrados.Count de @usuarios.Count usuarios
    </div>
}

@code {
    private List<UsuarioRegistrador> usuarios = new();
    private List<UsuarioRegistrador> usuariosFiltrados = new();
    private string filtroBusqueda = string.Empty;
    private bool isGenerandoPDF = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarUsuarios();
    }

    private async Task CargarUsuarios()
    {
        usuarios = await UsuarioService.ObtenerTodosAsync();
        AplicarFiltro();
    }

    private void AplicarFiltro()
    {
        if (string.IsNullOrWhiteSpace(filtroBusqueda))
        {
            usuariosFiltrados = usuarios;
        }
        else
        {
            var busqueda = filtroBusqueda.ToLower();
            usuariosFiltrados = usuarios.Where(u =>
                u.NombreCompleto.ToLower().Contains(busqueda) ||
                u.NumeroDocumento.Contains(busqueda) ||
                u.Correo.ToLower().Contains(busqueda) ||
                u.Permiso.ToLower().Contains(busqueda)
            ).ToList();
        }
    }

    private void LimpiarFiltro()
    {
        filtroBusqueda = string.Empty;
        AplicarFiltro();
    }

    /*private async Task GenerarPDF()
    {
        isGenerandoPDF = true;
        StateHasChanged();

        try
        {
            var pdfBytes = PdfGenerator.GenerarReporteUsuarios(usuariosFiltrados);
            
            // Crear descarga del archivo
            var fileName = $"Reporte_Usuarios_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";
            
            // Usar JS para descargar el archivo
            await JSRuntime.InvokeVoidAsync("descargarArchivo", fileName, Convert.ToBase64String(pdfBytes));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al generar PDF: {ex.Message}");
        }
        finally
        {
            isGenerandoPDF = false;
            StateHasChanged();
        }
    }*/

    private async Task GenerarPDF()
    {
        try
        {
            var pdfBytes = await PdfGenerator.GenerararPdf(usuarios);  // Cambiado _pdfGenerator a PdfGenerator
            var nombreArchivo = $"Usuarios_{DateTime.Now:yyyyMMddHHmmss}.pdf";
            await JSRuntime.InvokeVoidAsync("descargarArchivo", nombreArchivo, "application/pdf", Convert.ToBase64String(pdfBytes));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al generar PDF: {ex.Message}");
        }
    }
}